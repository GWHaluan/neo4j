A text-based adventure in Neo4j
===============================
:Author:    Richard Sill
:Email:     <rschroed2009@gmx.de>
:Date:       21.10.2023
:Revision:  1.0


About the project
-----------------

I drew inspiration from link:https://neo4j.com/blog/vampire-express-graph-database-choose-your-own-adventure/[Vampire Express: Graphing a Classic ’80s Choose Your Own Adventure Story] by Joe Depeau, one of the suggestions included in _Technical Writing challenge 1.4 - Google Docs.pdf_.

I first discovered _Choose Your Own Adventures_ when I was a teenager.
At the time I had a physical copy, a booklet that related thematically to a tabletop role-playing game.
It had me look up pages to proceed with the story and I really liked the unique way of interacting with the text, rather than just consuming the content.

Graph-based models of _Choose Your Own Adventures_ are well explored.
For example, some interesting aspects of such graph representations are covered in link:https://www.atlasobscura.com/articles/cyoa-choose-your-own-adventure-maps[These Maps Reveal the Hidden Structures of 'Choose Your Own Adventure' Books] by Sarah Laskow.

Unfortunately, I no longer had the booklet from 20 years ago (and I think it was in German language) nor any other _Choose Your Own Adventure_ books at the ready.
Instead, I went online and looked for a suitable digital model.

The data model
--------------

Getting hold of usable source data
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

I always loved link:https://www.imdb.com/title/tt0078748/?ref_=nv_sr_srsg_1_tt_7_nm_0_q_alien[Alien], so that was my go-to search term alongside _Choose Your Own Advenutre_.

I found the article link:https://www.polygon.com/2014/9/8/6123049/alien-aliens-avp-terror-aboard-the-speedwell[The best Alien game is a text adventure] by Danielle Riendeau which highly praises the adventure _The Terror Aboard the Speedwell_, written by Javy Gwaltney.
A free and playable version can be found link:https://jgwaltneiv.itch.io/the-terror-aboard-the-speedwell[here].

.To download the game:
. Click *Download*.
. In the overlay, click *No thanks, just take me to the downloads* above the donation input.
. For the HTML-based version, *Download* _The Terror Aboard The Speedwell 1.2.zip_ and unzip it.

Luckily, the HTML-based version contains the entire adventure as a set of +div+-elements which are sufficiently readable and more importantly easy to process.

Extracting the data
~~~~~~~~~~~~~~~~~~~

The +div+-elements with the story snippets inside _The Terror Aboard The Speedwell 1.2.html_ look like this:

[source,html]
----
<div tiddler="Begin" tags="" created="201408261301" modifier="twee" twine-position="1835,240">
The homeworld is nothing like you thought it would be. The landscape is black as tar and the temperature readings make you thankful for the air conditioning in your suit.

The crater, the reason for your journey, is dead ahead, a half mile in the distance. You don't mind the trek; this is a far cry from the 35 million miles you and your crew had to traverse for two months.

What a long way you’ve come, you muse. But what is an ending but the beginning of another journey, wrote…who wrote that? You wrack your brain for an answer. The answer is just outside the limits of your consciousness, floating. You reach for it, grasp its tail, and then—

Sergeant Ryan Benson turns around to look at you.

1.[[“Julia,” he says.]]
2.[[“Zoe,” he says.]]
</div>
----

[source,html]
----
<div tiddler="“Julia,” he says." tags="" created="201401271139" modifier="twee" twine-position="245,163">
“Julia, everything okay? You’ve got that look in your eyes.”

Ryan constantly feels some need to ask if you’re all right. Either out of attraction or platonic concern, you’re not sure which. However, you are certain that it bugs the snot out of you.

1.[[&quot;Yes, I’m fine.&quot;]]
2.[[&quot;Yes, Ryan, I’m fine.&quot;]]
3.[[&quot;I’m fine.&quot;]]
</div>
----

Note that occurrences of `\n` have been replaced with a carriage return in the listings above.

.Observations:
. The +tiddler+-attribute of a +div+-element represents the user's choice in the previous step in the story. It also serves as a unique identifier among the elements.
. Outgoing connections are typically enumerated as a list of links, embedded in double square brackets, but may occasionally also be found earlier throughout the text.

I wrote a link:divparser.py[Python script] to parse the +div+-elements and to create two CSV files, link:nodes.csv[nodes.csv] and link:edges.csv[edges.csv].
I chose the CSV file format because Neo4j allows the upload of CSV files into its data model.

._nodes.csv_:
[source,csv]
----
incoming,text
...
"Begin","The homeworld is nothing like you thought it would be. The landscape is black as tar and the temperature readings make you thankful for the air conditioning in your suit.\n\nThe crater, the reason for your journey, is dead ahead, a half mile in the distance. You don't mind the trek; this is a far cry from the 35 million miles you and your crew had to traverse for two months.\n\nWhat a long way you've come, you muse. But what is an ending but the beginning of another journey, wrote...who wrote that? You wrack your brain for an answer. The answer is just outside the limits of your consciousness, floating. You reach for it, grasp its tail, and then—\n\nSergeant Ryan Benson turns around to look at you.\n\n1.[[""Julia,"" he says.]]\n2.[[""Zoe,"" he says.]]\n\n"
...
"""Julia,"" he says.","""Julia, everything okay? You've got that look in your eyes.""\n\nRyan constantly feels some need to ask if you're all right. Either out of attraction or platonic concern, you're not sure which. However, you are certain that it bugs the snot out of you.\n\n1.[[""Yes, I'm fine.""]]\n2.[[""Yes, Ryan, I'm fine.""]]\n3.[[""I'm fine.""]]\n"
...
----

I treat the *incoming* column as the node's ID. The only other column is *text* to store the actual story snippet with the node.

._edges.csv_:
[source,csv]
----
from,to
...
"Begin","""Julia,"" he says."
...
----

Every edge is represented by the tuple made up of the IDs of the source and target nodes.

Populating the Neo4j graph
~~~~~~~~~~~~~~~~~~~~~~~~~~

First, I loaded up the two files _nodes.csv_ and _edges.csv_ this GitHub repository (link:https://github.com/GWHaluan/neo4j[https://github.com/GWHaluan/neo4j]) and then to Neo4j via the `LOAD CSV` link:https://neo4j.com/docs/cypher-manual/current/clauses/load-csv/[Cypher command], based on the queries explained in link:https://neo4j.com/docs/cypher-manual/current/clauses/load-csv/[LOAD CSV command with Cypher].

.Cypher query for _nodes.csv_:
[source]
----
LOAD CSV WITH HEADERS FROM "https://raw.githubusercontent.com/GWHaluan/neo4j/main/nodes.csv" AS row
MERGE (c:Storynode {id: row.incoming, text: row.text});
----

Note that I call values from the *incoming* column ``id``s in the Neo4j data model.

.Cypher query for _edges.csv_:
[source]
----
LOAD CSV WITH HEADERS FROM "https://raw.githubusercontent.com/GWHaluan/neo4j/main/edges.csv" AS row
MATCH (e:Storynode {id: row.from})
MATCH (c:Storynode {id: row.to})
MERGE (e)-[rel1:CONNECTS_TO]->(c) ON CREATE SET rel1.choice = row.to;
----

[comment]
--

delete commands:

[source]
----
MATCH ()-[r:CONNECTS_TO]->()
DELETE r
----

[source]
----
MATCH (n:Storynode)
DELETE n
----
--

Defining special nodes
~~~~~~~~~~~~~~~~~~~~~~

Sample text.

Querying the adventure graph
----------------------------

Q: Are there any circles in the story?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Courtesy of Joe Depeau.

Q: Are there unreachable story steps?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Sample text.

Q: Which paths finish the story? Survival or fatality?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Sample text.
